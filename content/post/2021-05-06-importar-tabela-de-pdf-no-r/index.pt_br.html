---
title: Importar tabela de PDF no R
author: Denis-OR
date: '2021-05-06'
slug: []
categories:
  - tabulizer
  - PDF
tags: []
Description: ''
Tags: []
Categories: []
DisableComments: no
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<pre class="r"><code>library(dplyr)
library(magrittr)
library(ggplot2)
library(gganimate)
library(patchwork)
library(tabulizer)</code></pre>
<pre class="r"><code>url &lt;- &#39;https://www.bp.com/content/dam/bp/business-sites/en/global/corporate/pdfs/energy-economics/statistical-review/bp-stats-review-2021-co2-emissions.pdf&#39;</code></pre>
<p>Função do <code>Tabulizer</code> <code>extract_tables</code></p>
<pre class="r"><code>crude_out &lt;- tabulizer::extract_tables(url, pages = 2, output = &quot;data.frame&quot;)</code></pre>
<p>O objeto <code>out</code> é uma lista contendo a estrutura da tabela extraída do <em>PDF</em>. Vamos transformar esta estrutura em um dataframe e analisá-la melhor.</p>
<pre class="r"><code>df_out &lt;- as.data.frame(crude_out[[1]])</code></pre>
<p>E aqui temos um ponto interessante. Ao extrairmos a tabela, é possível notar que algumas configurações vêm estranhas. Poderíamos chamar de desconfiguradas. Mas é normal, pois a formatação das tabelas, geralmente, incluem células mescladas, por exemplo. Logo, ao tentarmos encaixá-la em uma estrutura de linhas e colunas, digamos, normal, temos estas dificuldades.</p>
<p>Analisando a tabela, percebemos que as primeiras linhas são o cabeçalho. Vamos nos concentrar na segunda linha, pois faremos dela, o cabeçalho da nossa tabela.</p>
<pre class="r"><code>head(df_out)</code></pre>
<pre><code>##                                  X    X.1    X.2    X.3    X.4    X.5    X.6
## 1                                      NA     NA     NA     NA     NA     NA
## 2 Million tonnes of carbon dioxide 2010.0 2011.0 2012.0 2013.0 2014.0 2015.0
## 3                           Canada  550.1  554.7  551.1  564.6  571.8  570.2
## 4                           Mexico  454.8  473.0  476.7  483.2  471.2  475.2
## 5                               US 5495.0 5348.4 5101.5 5268.3 5277.6 5165.6
## 6              Total North America 6499.9 6376.1 6129.4 6316.1 6320.5 6211.0
##      X.7    X.8    X.9   X.10   X.11 Growth.rate.per.annum  X.12
## 1     NA     NA     NA     NA     NA                       Share
## 2 2016.0 2017.0 2018.0 2019.0 2020.0          2020 2009-19  2020
## 3  553.3  565.9  576.2  578.0  517.7           -10.7% 0.8%  1.6%
## 4  480.4  486.1  477.1  459.8  373.2           -19.0% 0.1%  1.2%
## 5 5060.8 5003.2 5166.0 5029.4 4457.2          -11.6% -0.5% 13.8%
## 6 6094.5 6055.2 6219.4 6067.1 5348.1          -12.1% -0.4% 16.6%</code></pre>
<p>Para isso, vamos utilizar a função <code>colnames</code>.</p>
<pre class="r"><code>colnames(df_out) &lt;- df_out[2,]
head(df_out)</code></pre>
<pre><code>##   Million tonnes of carbon dioxide   2010   2011   2012   2013   2014   2015
## 1                                      NA     NA     NA     NA     NA     NA
## 2 Million tonnes of carbon dioxide 2010.0 2011.0 2012.0 2013.0 2014.0 2015.0
## 3                           Canada  550.1  554.7  551.1  564.6  571.8  570.2
## 4                           Mexico  454.8  473.0  476.7  483.2  471.2  475.2
## 5                               US 5495.0 5348.4 5101.5 5268.3 5277.6 5165.6
## 6              Total North America 6499.9 6376.1 6129.4 6316.1 6320.5 6211.0
##     2016   2017   2018   2019   2020 2020 2009-19  2020
## 1     NA     NA     NA     NA     NA              Share
## 2 2016.0 2017.0 2018.0 2019.0 2020.0 2020 2009-19  2020
## 3  553.3  565.9  576.2  578.0  517.7  -10.7% 0.8%  1.6%
## 4  480.4  486.1  477.1  459.8  373.2  -19.0% 0.1%  1.2%
## 5 5060.8 5003.2 5166.0 5029.4 4457.2 -11.6% -0.5% 13.8%
## 6 6094.5 6055.2 6219.4 6067.1 5348.1 -12.1% -0.4% 16.6%</code></pre>
<p>Depois, deletamos as linhas e colunas indesejadas</p>
<pre class="r"><code>df_co2_w &lt;- df_out[3:85,1:12]
df_var_co2 &lt;- df_out[3:85,13:14]

df_var_co2 &lt;- tidyr::separate(
  df_var_co2,
  col = c(`2020 2009-19`),
  into = c(&quot;2020&quot;, &quot;2009-19&quot;),
  sep = &quot; &quot;
) %&gt;%
  tibble::add_column(var_2020 = df_var_co2$`2020`)</code></pre>
<p>Vamos focar em alguns países, de forma arbitrária:</p>
<pre class="r"><code>grupo_pais &lt;- c(&quot;Brazil&quot;,&quot;US&quot;,&quot;Canada&quot;,&quot;Sweden&quot;,
                &quot;Russian Federation&quot;,
                &quot;China&quot;,&quot;Japan&quot;,&quot;South Africa&quot;)</code></pre>
<pre class="r"><code>df_co2_l &lt;- df_co2_w %&gt;%
  tidyr::pivot_longer(cols = &quot;2010&quot;:&quot;2020&quot;,
                      names_to = &quot;Ano&quot;,
                      values_to = &quot;CO2_MT&quot;) %&gt;%
  rename(Pais = `Million tonnes of carbon dioxide`) %&gt;%
  filter(!stringr::str_detect(Pais, &quot;Total|Non|which|Other|European Union&quot;)) %&gt;%
  mutate(Ano = as.integer(Ano)) %&gt;% arrange(desc(CO2_MT))</code></pre>
<pre class="r"><code>df_co2_l %&gt;% #%&gt;% distinct(Pais) %&gt;% View()
  ggplot(aes(Ano, CO2_MT, group = Pais, color = Pais)) +
  geom_line(show.legend = F) +
  geom_point(size = 2, show.legend = F) +
  geom_text(
    data = df_co2_l  %&gt;% filter(Ano == 2020),
    aes(label = Pais, color = Pais),
    hjust = 0,
    nudge_x = 0.1,
    fontface = &quot;bold&quot;,
    size = 3,
    show.legend = F
  ) +
  scale_y_log10() +
  scale_x_continuous(breaks = seq(2010, 2020, 1), expand = c(0.01, 0)) +
  expand_limits(x = 2022) +
  theme_minimal() +
  theme(plot.margin = unit(c(0.35, 2, 0.3, 0.35), &quot;cm&quot;),)</code></pre>
<p><img src="/post/2021-05-06-importar-tabela-de-pdf-no-r/index.pt_br_files/figure-html/unnamed-chunk-10-1.png" width="864" style="display: block; margin: auto;" /></p>
<p>Não ficou muito bom. Vamos separar os cinco primeiros dos cinco últimos.</p>
<pre class="r"><code>top_five &lt;- df_co2_l %&gt;%
  filter(Ano == 2020) %&gt;%
  head(5) %&gt;%
  pull(Pais)

top_bottom &lt;- df_co2_l %&gt;%
  filter(Ano == 2020) %&gt;%
  tail(5) %&gt;%
  pull(Pais)

gg1 &lt;- ggplot(data = df_co2_l %&gt;% filter(Pais %in% top_five),
              aes(Ano, CO2_MT, group = Pais, color = Pais)) +
  geom_line() +
  geom_point(size = 2) +
  labs(color = &quot;Top five&quot;) +
  theme_minimal()

gg2 &lt;- ggplot(data = df_co2_l %&gt;% filter(Pais %in% top_bottom),
              aes(Ano, CO2_MT, group = Pais, color = Pais)) +
  geom_line() +
  geom_point(size = 2) +
  labs(color = &quot;Bottom five&quot;) +
  theme_minimal()

gg1/gg2</code></pre>
<p><img src="/post/2021-05-06-importar-tabela-de-pdf-no-r/index.pt_br_files/figure-html/unnamed-chunk-11-1.png" width="864" style="display: block; margin: auto;" /></p>
